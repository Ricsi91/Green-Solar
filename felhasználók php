-- Adatbázis: `napelem_db` (Karakterkódolás: utf8mb4_hungarian_ci)

-- Táblák kiürítése (ha már léteznek) az új adatok feltöltése előtt
SET FOREIGN_KEY_CHECKS=0;
TRUNCATE TABLE IF EXISTS `alkatresz_lokaciok`;
TRUNCATE TABLE IF EXISTS `rekeszek`;
TRUNCATE TABLE IF EXISTS `projekt_alkatreszek`;
TRUNCATE TABLE IF EXISTS `projektek`;
TRUNCATE TABLE IF EXISTS `alkatreszek`;
TRUNCATE TABLE IF EXISTS `felhasznalok`;
SET FOREIGN_KEY_CHECKS=1;

-- 1. Alkatrészek tábla (változatlan)
CREATE TABLE IF NOT EXISTS `alkatreszek` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `nev` VARCHAR(255) NOT NULL,
  `ar` DECIMAL(10, 2) NOT NULL DEFAULT 0.00,
  `max_darab_rekeszben` INT NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_hungarian_ci;

-- 2. Felhasználók tábla (változatlan)
CREATE TABLE IF NOT EXISTS `felhasznalok` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `felhasznalonev` VARCHAR(100) NOT NULL UNIQUE,
  `jelszo_hash` VARCHAR(255) NOT NULL,
  `szerep` ENUM('Szakember', 'Raktarvezeto', 'Raktaros', 'Admin') NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_hungarian_ci;

-- 3. ÚJ: Projektek tábla (Funkció A.1, A.2, C.1 [1])
CREATE TABLE IF NOT EXISTS `projektek` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `nev` VARCHAR(255) NOT NULL,
  `helyszin` VARCHAR(255) NULL,
  `statusz` ENUM('New', 'Draft', 'Wait', 'Scheduled', 'InProgress', 'Completed', 'Failed') NOT NULL DEFAULT 'New' COMMENT 'Projekt állapotok [1]'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_hungarian_ci;

-- 4. ÚJ: Rekeszek tábla (Raktár elrendezés, Funkció 1.d [1])
CREATE TABLE IF NOT EXISTS `rekeszek` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `sor` INT NOT NULL,
  `oszlop` INT NOT NULL,
  `szint` INT NOT NULL,
  `egyedi_azonosito` VARCHAR(50) NULL COMMENT 'Pl. "A-01-01" vagy "58. rekesz" [1]'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_hungarian_ci;

-- 5. ÚJ: Projekt-alkatrészek összekötő tábla (Funkció A.4 [1])
CREATE TABLE IF NOT EXISTS `projekt_alkatreszek` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `projekt_id` INT NOT NULL,
  `alkatresz_id` INT NOT NULL,
  `szukseges_darab` INT NOT NULL DEFAULT 1,
  FOREIGN KEY (`projekt_id`) REFERENCES `projektek`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`alkatresz_id`) REFERENCES `alkatreszek`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_hungarian_ci;

-- 6. ÚJ: Alkatrész-lokációk (Készlet tárolása, Funkció B.5, B.6, C.2 [1])
CREATE TABLE IF NOT EXISTS `alkatresz_lokaciok` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `alkatresz_id` INT NOT NULL,
  `rekesz_id` INT NOT NULL,
  `darab` INT NOT NULL DEFAULT 0 COMMENT 'Aktuális készlet a rekeszben',
  FOREIGN KEY (`alkatresz_id`) REFERENCES `alkatreszek`(`id`),
  FOREIGN KEY (`rekesz_id`) REFERENCES `rekeszek`(`id`),
  UNIQUE KEY `rekesz_egyedi_alkatresz` (`rekesz_id`) COMMENT 'B.6: Egy rekeszbe csak egyféle alkatrész mehet [1]'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_hungarian_ci;


-- --- MINTA ADATOK BŐVÍTÉSE ---

-- Alkatrészek
INSERT INTO `alkatreszek` (`nev`, `ar`, `max_darab_rekeszben`) VALUES
('Napelem panel 300W (mono)', 45000.00, 10),
('Inverter 5kW (Huawei)', 350000.00, 2),
('Tartókonzol (tetőcseréphez)', 1500.00, 100),
('Szolár kábel (méter)', 450.00, 500);

-- Felhasználók
-- Jelszavak: admin123, szak123, raki123
INSERT INTO `felhasznalok` (`felhasznalonev`, `jelszo_hash`, `szerep`) VALUES
('admin', '$2y$10$T89lb.bXjSSb..fxs.T/Me2oGCMzS11lGqXyFG.DNrZ.f2o.mdv0a', 'Admin'),
('szakember_anna', '$2y$10$WqT5pL/eJd8M.Lp3S9mR/eIS5D/T0BvQeD.G.D.T/1e.eY6zG2l.S', 'Szakember'),
('raktaros_bela', '$2y$10$q.9s.C.P/K8N.F.w/J.F.O/X/T.y.W.q/J/y.U/d.Z/a.F.c.d.O', 'Raktaros'),
('raktarvezeto_geza', '$2y$10$N.8f.t.s/W.b.B.O.T.p.P/o/f.g.h.i.j.k.l.m.n.o.p', 'Raktarvezeto');

-- Projektek
-- Bővítve A.1. funkció alapján: leiras, megrendelo_adatok
ALTER TABLE `projektek`
    ADD COLUMN `leiras` TEXT NULL AFTER `helyszin`,
    ADD COLUMN `megrendelo_adatok` TEXT NULL COMMENT 'Pl. Név, cím, email - A.1. funkció' AFTER `leiras`;
    
TRUNCATE TABLE `projektek`;
INSERT INTO `projektek` (`nev`, `helyszin`, `statusz`) VALUES
('Nagy Családi Ház', 'Budapest, Fő utca 1.', 'Scheduled'), -- Raktárosnak releváns
('Kovács Nyaraló', 'Balaton, Rákóczi út 22.', 'InProgress'), -- Raktárosnak releváns
('Tervezés Alatt Kft.', 'Debrecen, Iroda tér 5.', 'Draft'); -- Raktárosnak NEM releváns

-- Rekeszek (Raktár térkép)
INSERT INTO `rekeszek` (`sor`, `oszlop`, `szint`, `egyedi_azonosito`) VALUES
(1, 1, 1, 'A-01-01'), -- Napelemek helye
(1, 1, 2, 'A-01-02'), -- Napelemek másik helye
(3, 5, 1, 'C-05-01'), -- Inverterek helye
(5, 2, 4, 'E-02-04'); -- Konzolok helye

-- Projekt alkatrész igények
-- 'Nagy Családi Ház' (projekt_id = 1)
INSERT INTO `projekt_alkatreszek` (`projekt_id`, `alkatresz_id`, `szukseges_darab`) VALUES
(1, 1, 12), -- 12 db Napelem panel (id=1)
(1, 2, 1),  -- 1 db Inverter (id=2)
(1, 3, 48); -- 48 db Tartókonzol (id=3)

-- 'Kovács Nyaraló' (projekt_id = 2)
INSERT INTO `projekt_alkatreszek` (`projekt_id`, `alkatresz_id`, `szukseges_darab`) VALUES
(2, 1, 8); -- 8 db Napelem panel (id=1)

-- Alkatrészek elhelyezése a rekeszekben (Készlet)
INSERT INTO `alkatresz_lokaciok` (`alkatresz_id`, `rekesz_id`, `darab`) VALUES
(1, 1, 10), -- Napelem (id=1) az A-01-01 rekeszben, 10 db
(1, 2, 5),  -- Napelem (id=1) az A-01-02 rekeszben, 5 db (összesen 15 db van raktáron)
(2, 3, 20), -- Inverter (id=2) a C-05-01 rekeszben, 20 db
(3, 4, 500); -- Tartókonzol (id=3) az E-02-04 rekeszben, 500 db
-- A Szolár kábel (id=4) nincs raktáron, nincs lokációja.
